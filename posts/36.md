---
title: Sanity CMS
date: '2023-05-05'
---

## Vercel の Visual Editing

なんかブラウザで CMS のコンテンツを編集できるやつです。

https://twitter.com/vercel/status/1653791607609761799?s=20

[Visual Editing | Vercel Docs](https://vercel.com/docs/workflow-collaboration/visual-editing)

> Visual Editing, currently in a limited private beta, is accessible for Enterprise Teams using Sanity as their content editing workflow. To participate in this or future private betas, contact us for more information.

とのことなので、CMS [Sanity](https://www.sanity.io/) を試しに使ってみようと思います。

## Sanity Web でプロジェクトを用意

この辺はぽちぽちやってけば大丈夫です。

最後に、 local で立ち上げる sanity の管理画面 （studio と呼ばれているらしい） をインストールするコマンドを教えてくれました。

```
npm create sanity@latest -- --template get-started --project *** --dataset production --provider google
```

というわけで、Sanity にはクラウドの管理画面がないみたいです。

## Next.js の環境にインストール

```diff
  ./
  ├── pages/
  │   ├── ...
+ │　　　　　　└── studio/
+ ├── sanity/
+ │   ├── lib/
+ │   ├── schema.ts
+ │   └── schemas/
+ ├── sanity.cli.ts
+ ├── sanity.config.ts
  ├── package-lock.json
  ├── package.json
  ├── ...
```

- `./sanity/` - なんかデータの schema やらなんやら
- `./pages/studio/` - `localhost:3000/studio` で管理画面が開ける

## 実際にデータを編集する

画面はこんな感じ。別に使いやすくはなかったです。

![](https://storage.googleapis.com/zenn-user-upload/4e2ac678da93-20230505.png)

## Next.js から呼び出す

大まかには以下のような感じ。

```ts
import { createClient } from 'next-sanity'
import { apiVersion, dataset, projectId } from '@/sanity/env'

const client = createClient({
  projectId: projectId,
  dataset: dataset,
  apiVersion: apiVersion,
  useCdn: false
})

export const getStaticProps = async () => {
  const posts = await client.fetch(`*[_type == "post"]`)
  // ...
}
```

気になるところは後述します。

## 辛かったところ

### クエリが独自

とにかくクエリを覚えないといけないのが微妙でした。Copilot がなかったら補完も効かない。

[How GROQ Queries Work - Step by Step Guide](https://www.sanity.io/docs/how-queries-work)

```ts
client.fetch(`*[_type == "post" && slug.current == ${slug}]`)
```

### ブログの Body とかが、HTML 文字列じゃなくて、ブロック構造になっているが、Parser は自前で用意しろスタイル

こんな感じで、結構気を遣って構造化してくれているんですが、Parser が用意されてないので、HTML に直すところでめんどくさくなり諦めました。

```ts
body: [
  {
    style: 'h2',
    _key: 'f8a7d4e3e019',
    markDefs: [],
    children: [Array],
    _type: 'block'
  },
  {
    markDefs: [],
    children: [Array],
    _type: 'block',
    style: 'normal',
    _key: '78957f0d9762'
  }
  // ...
]
```

### せっかく Schema As Code なのに、Type や Interface がない

ので、自前で用意しました。
ただ、どんな構造なのか、いちいちドキュメントを読まないといけない。

## まとめ

まだちょっとつらいです。ドキュメントを一通り読みましたが、抜け漏れがあるかもしれません。補足等お願いします。
